<?php
// Require PHP mailer
set_include_path("/Users/evankirkiles/Desktop/ParanoiaWebsite");
require_once "vendor/autoload.php";

$servername = 'den1.mysql6.gear.host';
$username = 'paranoiasystem';
$password = 'Eb09c~g0~4vZ';
$db = 'paranoiasystem';

// To whom should the emails be sent
$setting = $_POST['setting'];
// If a specific player is specified, do them
$player = $_POST['specificplayer'];
// The email text to be sent
$email = $_POST['emailtext'];

// SQL command to get all players emails from database
$sql_emails = 'SELECT email FROM paranoia';
// SQL command to get all living players emails from database
$sql_emails_living = 'SELECT email FROM paranoia WHERE eliminated=0';
// SQL command to get the email of a specific codename
$sql_specific_codename = 'SELECT email FROM paranoia WHERE codename="';

// Success code global
$success = true;

// Create connection
$conn = new mysqli($servername, $username, $password, $db);
// Check connection
if ($conn -> connect_error) {
  die("Connection failed: " . $conn->connect_error);
}

// Build the query string depending on who we want to email
$query = '';
if ($setting == 'all') {
	$query = $sql_emails;
} elseif ($setting == 'living') {
	$query = $sql_emails_living;
} else {
	$query = $sql_specific_codename + $player + '"';
}

// Perform the query and retrieve list of emails
$results = $conn->query($query);
$list = array();
if ($results) {
  foreach($results->fetch_all() as $data) {
    if (!($data[0] == null || $data[0] == '')) { 
    	array_push($list, $data[0]);
    }
  }
} else {
  $success = false;
}

// Close the MySQL database question
$conn->close();

$transport = new Swift_SmtpTransport('smtp.gmail.com', 465, 'ssl');
$transport->setUsername('kirkilese20@kent-school.edu');
$transport->setPassword('ew359854');

$mailer = (new Swift_Mailer($transport));

foreach($list as $emailText) {
  $message = (new Swift_Message('Test Subject'));
  $message->setFrom(array('kirkilese20@kent-school.edu' => 'The Paranoia Staff'))
    ->setTo(array($emailText))
    ->setBody($email);

  $result = $mailer->send($message);
}

echo $success;
?>